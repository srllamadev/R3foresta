<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R3foresta Credits</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
    <style>
      .hidden { display: none; }
    </style>
  </head>
  <body>

    
    <section class="section__container contract__container" id="contract">
      <div class="contract__actions">
        <div class="action-cards">
          <div class="action-card">
            <button class="action-toggle" data-target="buyForm">
              <span><i class="ri-shopping-bag-line"></i> Comprar Bonos</span>
              <span class="arrow">▼</span>
            </button>
            <div id="buyForm" class="action-form">
              <div class="form-group">
                <label for="paymentAmount">Monto a pagar en wei:</label>
                <input type="number" id="paymentAmount" min="100" step="100" value="100" />

              </div>
              <div class="form-group">
                <p>Toneladas de carbono: <span id="elemento"></span></p>
              </div>
              <button class="btn btn--primary" id="submitBuy">
                <i class="ri-check-line"></i> Confirmar Compra
              </button>
            </div>

            <script>
                const paymentAmountInput = document.getElementById('paymentAmount');
                const elemento = document.getElementById('elemento');

                // Asegura que el valor se restablezca a cero al cargar la página
                window.onload = function() {
                    paymentAmountInput.value = 0; // Restablece a 0
                    elemento.textContent = '0'; // Restablece toneladas a 0
                };


                paymentAmountInput.addEventListener('input', () => {
                    const weiAmount = parseFloat(paymentAmountInput.value);
                    
                    // Convertir wei a dólares (suponiendo que 1 wei = 0.00000001 $)
                    const dollarAmount = weiAmount * 0.00000001; // Ajusta este valor según tu conversión real.
                    
                    // Convertir dólares a toneladas
                    const toneladas = (dollarAmount / 10) * 100; // 10$ = 100 toneladas
                    elemento.textContent = toneladas.toFixed(2); // Mostrar con dos decimales
                });
            </script>


          </div>
        </div>
      </div>
    </section>

    <script>
      const contractAddress = "0xa9D8ca2C6FBd457973106f04bDA4655ffCDAa4aA";
      const abi = [
        {
          "inputs": [],
          "name": "comprarBonos",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [{"internalType":"address","name":"usuario","type":"address"}],
          "name": "obtenerToneladas",
          "outputs": [{"internalType":"uint256","name":"","type":"uint256"}],
          "stateMutability": "view",
          "type": "function"
        }
      ];

      let provider, signer, contract;

      async function connectWallet() {
        if (window.ethereum) {
          provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);
          console.log("Conectado con:", await signer.getAddress());
        } else {
          alert("MetaMask no está disponible");
        }
      }

      connectWallet();

      document.getElementById("paymentAmount").addEventListener("input", (e) => {
        const wei = parseInt(e.target.value);
        const toneladas = (wei * 10) / 100; // 100 wei = 10 ton
        document.getElementById("elemento").innerText = toneladas;
      });

      document.getElementById("submitBuy").addEventListener("click", async () => {
        const valueInWei = document.getElementById("paymentAmount").value;
        try {
          const tx = await contract.comprarBonos({ value: valueInWei });
          await tx.wait();
          //alert("¡Compra realizada!");
        } catch (err) {
          console.error(err);
          alert("Error al realizar la compra");
        }
      });
    </script>
  </body>
</html>
